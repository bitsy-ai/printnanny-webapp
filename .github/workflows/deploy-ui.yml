name: Deploy UI
on:
  workflow_dispatch:

jobs:
  deploy:
    environment: live
    env:
      PRINTNANNY_API_URL: "https://api.printnanny.ai"
      UI_DEPLOY_PATH: "gs://print-nanny-cdn/ui/"
      GCP_SERVICE_ACCOUNT: ${{ secrets.PROD_GCP_SERVICE_ACCOUNT }}
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.PROD_GCP_SERVICE_ACCOUNT_KEY  }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - name: Write deploy key
        run: echo $GCP_SERVICE_ACCOUNT_KEY > key.json
      - name: Active Service Account
        run: gcloud auth activate-service-account $GCP_SERVICE_ACCOUNT --key-file=key.json

      - name: Deploy UI
        id: deploy
        run: |
          make ui-build
          make ui-deploy
      - name: Deployed UI Build
        env:
          DISCORD_WEBHOOK: ${{ secrets.PRINT_NANNY_DISCORD_DEPLOY_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
          args: |
            ðŸš€ Deployed {{ EVENT_PAYLOAD.repository.full_name }}@{{ GITHUB_SHA }} ðŸš€
            ```
            API Client version: ${{ steps.deploy.outputs.printnanny_client_version }}
            ```
