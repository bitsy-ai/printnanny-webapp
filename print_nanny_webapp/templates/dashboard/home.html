{% extends "vertical_base.html" %}
{% load static %}
{% load crispy_forms_tags %}


{% block blocktitle %}Welcome back!{% endblock %}

{% block content %}
<div class="container-fluid">

{% if user == request.user %}
<!-- Action buttons -->
<div class="row mt-3">
  <div class="col-sm-12 col-md-6">
    <div class="card">
      <div class="card-body">
        <h2 class="header-title">User Settings</h2>

        <form>
          <label class="my-1 mr-2" for="token">API Token</label>
          <p class="text-muted font-14">
            Your API token is used to connect OctoPrint to Print Nanny. Treat this token like a password; do not share or publish it online. 
          </p>
            <div class="input-group">
              <input id="token" type="password" class="form-control"
                  value="{{ user.token }}" id="copy-input" readonly>
              <div class="input-group-append" data-password="false">
              <div class="input-group-text">
                  <span class="password-eye"></span>
              </div>
              </div>
            </div>
        </form>

        <h2 class="header-title mt-3">Notification Settings</h2>

        <form method="POST">

          {% csrf_token %}
          {{ forms.user_settings | crispy }}

          <button name="action" value="user_settings" type="submit" class="btn btn-lg btn-primary">Save</button> 

        </form>

        
      </div>
    </div> 
  </div>
  <div class="col-sm-12 col-md-6">
    <div class="card">
      <div class="card-body">
          <h2 class="header-title">
            Recent Alerts
          </h2>
            <p class="text-muted font-14">
              Sending email notifications to <strong>{{ user.email }}</strong>.
            </p>

          {% if recent_alerts.count == 0 %}
            <p class="font-14">
              You're all caught up! Unread alerts will appear here.
            </p>          
          {% endif %}
      </div>
    </div>
  </div>

</div>

{% include "partials/octoprint-devices-list.html" %}

{% include "partials/livestream.html" %}

<!-- End Action buttons -->
{% endif %}


</div>

<!-- plugin js -->
<!-- init js -->


{% endblock content %}

<script>
  const loading = document.querySelector('#stream-loading');

  const video = document.querySelector('#stream');
  
  const WS_URL = "{{ WS_BASE_URL }}/video/";
  const ws = new WebSocket(WS_URL);

  ws.onmessage = (msg) => {
    video.src = "data:image/png;base64," + msg.data
    loading.style.display = 'none';
  }
  ws.onopen = () => {
    console.log(`Connected to ${WS_URL}`);
  }
</script>